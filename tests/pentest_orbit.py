import asyncio
import websockets
import json

async def test_unauthorized_access():
    print("--- üïµÔ∏è PENTEST: PRUEBA 01 - ACCESO SIN TOKEN ---")
    url = "ws://localhost:8000/ws/mcp"
    try:
        async with websockets.connect(url) as websocket:
            print("‚ùå FALLO: El servidor permiti√≥ la conexi√≥n sin token.")
    except Exception as e:
        print(f"‚úÖ √âXITO: Conexi√≥n rechazada. Error esperado.")

async def test_invalid_token():
    print("\n--- üïµÔ∏è PENTEST: PRUEBA 02 - TOKEN INV√ÅLIDO ---")
    url = "ws://localhost:8000/ws/mcp?token=fake_token_123"
    try:
        async with websockets.connect(url) as websocket:
            print("‚ùå FALLO: El servidor acept√≥ un token falso.")
    except Exception as e:
        print(f"‚úÖ √âXITO: Token rechazado por el servidor.")

async def test_panic_hijack():
    print("\n--- üïµÔ∏è PENTEST: PRUEBA 03 - SECUESTRO DE P√ÅNICO (MALICIOUS HALT) ---")
    # Este intento simula a un atacante intentando enviar un HALT sin estar autenticado
    url = "ws://localhost:8000/ws/mcp"
    try:
        async with websockets.connect(url) as ws:
            await ws.send(json.dumps({"type": "HALT_SIGNAL"}))
            print("‚ùå FALLO: El atacante pudo enviar una se√±al de HALT.")
    except:
        print("‚úÖ √âXITO: El canal est√° bloqueado para atacantes no autorizados.")

if __name__ == "__main__":
    asyncio.run(test_unauthorized_access())
    asyncio.run(test_invalid_token())
    asyncio.run(test_panic_hijack())
